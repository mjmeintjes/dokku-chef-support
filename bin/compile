#!/usr/bin/env bash

# Usage:
#
# $ bin/compile <build-dir> <cache-dir> <env-path>

# Fail fast and fail hard.
set -eo pipefail

CACHED_DIRS=".chefbp"



# Paths.
BIN_DIR=$(cd $(dirname $0); pwd) # absolute path
ROOT_DIR=$(dirname $BIN_DIR)
BUILD_DIR=$1
CACHE_DIR=$2
ENV_FILE=$3


# Directory Hacks for path consistiency.
APP_DIR='/app'
TMP_APP_DIR=$CACHE_DIR/tmp_app_dir

# ### The Cache
mkdir -p $CACHE_DIR/.chefbp


cd $CACHE_DIR
mkdir $CACHED_DIRS &> /dev/null
cd .chefbp
if [ ! -f chef-installed ]; then
    curl -L https://www.opscode.com/chef/install.sh | sudo bash
    /opt/chef/embedded/bin/gem install berkshelf
    touch chef-installed
fi

echo '
  file_cache_path "'$CACHE_DIR'/chef"
  cookbook_path "'$CACHE_DIR'/cookbooks"
' > $CACHE_DIR/.chefbp/solo.rb


mkdir -p "$CACHE_DIR/cookbooks"

cd $APP_DIR
cd provision
/opt/chef/embedded/bin/berks install --path "$CACHE_DIR/cookbooks"
chef-solo -c $CACHE_DIR/.chefbp/solo.rb  -o "recipe[facebook_insights::default]"
